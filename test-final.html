<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema Reservas - Actualización Automática</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .horario-reservado { background-color: #f8d7da !important; border-color: #dc3545 !important; }
        .horario-disponible { background-color: #d1e7dd !important; border-color: #198754 !important; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2><i class="fas fa-bug"></i> Test - Sistema de Reservas Actualizado</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>🧪 Probar Horarios</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="fecha" class="form-label">Fecha:</label>
                            <input type="date" class="form-control" id="fecha" value="2025-06-30">
                        </div>
                        
                        <button class="btn btn-primary" onclick="cargarHorarios()">
                            <i class="fas fa-refresh"></i> Cargar Horarios
                        </button>
                        
                        <div id="horariosContainer" style="display: none;" class="mt-3">
                            <div class="horarios-container">
                                <div class="horarios-header">
                                    <h4><i class="fas fa-clock"></i> Horarios Disponibles</h4>
                                </div>
                                <div class="horarios-info">
                                    <p class="text-muted" id="carga-info"></p>
                                </div>
                                <div class="horarios-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>📋 Log de Debug</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" style="height: 400px; overflow-y: auto; background: #000; color: #00ff00; padding: 10px; font-family: monospace; font-size: 12px;"></div>
                        <button class="btn btn-warning btn-sm mt-2" onclick="clearLog()">Limpiar Log</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="src/frontend/api-helper.js"></script>
    <script>
        // Override console.log para capturar en debug panel
        const originalLog = console.log;
        const debugLogEl = document.getElementById('debugLog');
        
        function addToDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLogEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugLogEl.scrollTop = debugLogEl.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToDebugLog(args.join(' '));
        };
        
        function clearLog() {
            debugLogEl.innerHTML = '';
        }
        
        async function cargarHorarios() {
            const fecha = document.getElementById('fecha').value;
            console.log('🚀 Cargando horarios para:', fecha);
            
            try {
                const timestamp = new Date().getTime();
                const endpoint = `/api/bookings/available-slots?date=${fecha}&_t=${timestamp}`;
                console.log('📡 Endpoint:', endpoint);
                
                const infoText = document.getElementById('carga-info');
                infoText.innerHTML = '<span class="badge bg-primary"><i class="fas fa-database fa-spin me-1"></i> Consultando base de datos...</span>';
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                console.log('📊 Respuesta:', JSON.stringify(data, null, 2));
                
                if (data.data && Array.isArray(data.data)) {
                    procesarHorarios(data.data);
                } else {
                    console.error('❌ Formato de datos inválido');
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
            }
        }
        
        function procesarHorarios(horarios) {
            console.log('🔄 Procesando horarios:', horarios);
            
            const horariosGrid = document.querySelector('.horarios-grid');
            horariosGrid.innerHTML = '';
            
            horarios.forEach(slot => {
                const isReserved = slot.isBooked === true;
                console.log(`${isReserved ? '🔒' : '✅'} ${slot.time} - ${isReserved ? 'RESERVADO' : 'DISPONIBLE'}`);
                
                const btn = document.createElement('button');
                btn.textContent = slot.time;
                btn.className = 'btn m-1';
                
                if (isReserved) {
                    btn.className += ' btn-danger horario-reservado';
                    btn.disabled = true;
                    btn.innerHTML = `${slot.time} <i class="fas fa-times-circle ms-1"></i>`;
                    btn.title = 'RESERVADO - NO DISPONIBLE';
                } else {
                    btn.className += ' btn-success horario-disponible';
                    btn.innerHTML = `${slot.time} <i class="fas fa-check-circle ms-1"></i>`;
                    btn.title = 'DISPONIBLE';
                }
                
                horariosGrid.appendChild(btn);
            });
            
            document.getElementById('horariosContainer').style.display = 'block';
            
            const horariosDisponibles = horarios.filter(slot => !slot.isBooked).length;
            const horariosReservados = horarios.filter(slot => slot.isBooked).length;
            
            const infoText = document.getElementById('carga-info');
            infoText.innerHTML = `
                <span class="badge bg-success">${horarios.length} total</span>
                <span class="badge bg-info">${horariosDisponibles} disponibles</span>
                <span class="badge bg-warning">${horariosReservados} reservados</span>
            `;
            
            console.log('✅ Horarios procesados correctamente');
        }
        
        // Auto-cargar al inicio
        window.onload = () => {
            console.log('🎯 Test de Sistema de Reservas - Cargado');
            cargarHorarios();
        };
    </script>
</body>
</html>
