<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend - Car Wash</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Test Car Wash Reservations</h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h3>Selecciona una fecha:</h3>
                <input type="date" id="fecha" class="form-control" min="2025-01-01">
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div id="horariosContainer" style="display: none;">
                    <!-- Los horarios se cargarán aquí -->
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div id="debug-info" class="alert alert-info">
                    <h5>Debug Info:</h5>
                    <pre id="debug-output"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Debug functions
        window.debugLog = function(msg, data) {
            console.log(msg, data);
            const output = document.getElementById('debug-output');
            output.textContent += new Date().toISOString() + ' - ' + msg + (data ? ' ' + JSON.stringify(data) : '') + '\n';
        };
        
        window.debugError = function(msg, error) {
            console.error(msg, error);
            const output = document.getElementById('debug-output');
            output.textContent += new Date().toISOString() + ' - ERROR: ' + msg + (error ? ' ' + error.toString() : '') + '\n';
        };
        
        function mostrarError(mensaje) {
            alert('ERROR: ' + mensaje);
        }
    </script>
    <script src="src/frontend/api-helper.js"></script>
    <script>
        // Test del selector de fecha
        document.getElementById('fecha').addEventListener('change', async function () {
            try {
                window.debugLog('Fecha seleccionada:', this.value);
                
                // Validar formato de fecha y crear fecha en zona horaria local
                if (!this.value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    mostrarError('Formato de fecha inválido');
                    this.value = '';
                    return;
                }

                // Crear fecha usando componentes locales para evitar problemas de timezone
                const [year, month, day] = this.value.split('-').map(Number);
                const fecha = new Date(year, month - 1, day); // month es 0-indexado
                const ahora = new Date();
                // Resetear la hora de 'ahora' para comparar solo fechas
                ahora.setHours(0, 0, 0, 0);

                window.debugLog('Fecha procesada:', fecha.toLocaleDateString());
                window.debugLog('Día de la semana:', fecha.getDay());

                // Validar que la fecha sea válida
                if (isNaN(fecha.getTime())) {
                    mostrarError('Fecha no válida');
                    this.value = '';
                    return;
                }

                // Validar que la fecha sea futura o hoy
                if (fecha < ahora) {
                    window.debugLog('Fecha rechazada: es pasada');
                    mostrarError('Por favor, selecciona una fecha futura');
                    this.value = '';
                    return;
                }

                // Obtener el día de la semana (0 = Domingo, 1 = Lunes, ..., 6 = Sábado)
                const dia = fecha.getDay();

                // Validar que no sea domingo
                if (dia === 0) {
                    window.debugLog('Fecha rechazada: es domingo');
                    mostrarError('Lo sentimos, no atendemos los domingos');
                    this.value = '';
                    return;
                }

                const horariosContainer = document.getElementById('horariosContainer');
                
                // Formatear la fecha para la API (usar directamente el valor del input)
                const fechaFormateada = this.value; // Ya está en formato YYYY-MM-DD
                
                horariosContainer.innerHTML = '<div class="alert alert-info">Cargando horarios...</div>';
                horariosContainer.style.display = 'block';

                // Realizar la petición al backend
                const timestamp = new Date().getTime();
                const endpoint = `/bookings/available-slots?date=${fechaFormateada}&_t=${timestamp}`;
                
                window.debugLog('Iniciando petición:', endpoint);

                // Verificar que apiRequest esté disponible
                if (typeof apiRequest === 'undefined') {
                    throw new Error('apiRequest no está definida. API Helper no se cargó correctamente.');
                }

                // Usar la función helper para realizar la petición
                const data = await apiRequest(endpoint);
                window.debugLog('Respuesta recibida:', data);

                // Procesar respuesta
                if (data && data.data && Array.isArray(data.data)) {
                    window.debugLog('Datos válidos recibidos, cantidad de slots:', data.data.length);
                    
                    const horariosHTML = data.data.map(slot => `
                        <div class="alert ${slot.isBooked ? 'alert-danger' : 'alert-success'} p-2 m-1">
                            <strong>${slot.time}</strong> - ${slot.isBooked ? 'OCUPADO' : 'DISPONIBLE'}
                        </div>
                    `).join('');
                    
                    horariosContainer.innerHTML = `
                        <h4>Horarios para ${fechaFormateada}</h4>
                        <div class="d-flex flex-wrap">
                            ${horariosHTML}
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Fuente: ${data.dataSource || 'desconocida'}</small>
                        </div>
                    `;
                } else {
                    horariosContainer.innerHTML = '<div class="alert alert-danger">Error: No se pudieron cargar los horarios desde la base de datos.</div>';
                    window.debugError('Datos inválidos recibidos:', data);
                }
                
            } catch (error) {
                window.debugError('Error al obtener horarios:', error);
                const horariosContainer = document.getElementById('horariosContainer');
                horariosContainer.innerHTML = '<div class="alert alert-danger">Error de conexión: ' + error.message + '</div>';
                horariosContainer.style.display = 'block';
            }
        });
    </script>
</body>
</html>
