<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîç Monitor de Reservas en Tiempo Real</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .monitor-card {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .log-area {
        background: #1e1e1e;
        color: #00ff00;
        font-family: "Courier New", monospace;
        height: 300px;
        overflow-y: auto;
        padding: 15px;
        border-radius: 5px;
      }
      .status-badge {
        font-size: 0.9em;
        padding: 8px 12px;
      }
      .horario-disponible {
        background: #d1e7dd !important;
        border: 2px solid #198754 !important;
        color: #0f5132 !important;
      }
      .horario-ocupado {
        background: #f8d7da !important;
        border: 2px solid #dc3545 !important;
        color: #721c24 !important;
      }
      .refresh-btn {
        animation: spin 2s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container-fluid mt-3">
      <div class="row">
        <div class="col-md-12">
          <div class="monitor-card card">
            <div class="card-header bg-primary text-white text-center">
              <h3>
                <i class="fas fa-eye"></i> Monitor de Reservas - Sistema en
                Tiempo Real
              </h3>
              <p class="mb-0">
                Verificando actualizaci√≥n autom√°tica de horarios
              </p>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="fechaMonitor" class="form-label"
                    >üìÖ Fecha a monitorear:</label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="fechaMonitor"
                    value="2025-07-01"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">üîÑ Actualizaci√≥n:</label><br />
                  <button
                    class="btn btn-success"
                    onclick="consultarHorarios()"
                    id="btnConsultar"
                  >
                    <i class="fas fa-sync-alt"></i> Consultar Ahora
                  </button>
                  <button
                    class="btn btn-info ms-2"
                    onclick="toggleAutoRefresh()"
                    id="btnAuto"
                  >
                    <i class="fas fa-play"></i> Auto-refresh
                  </button>
                </div>
                <div class="col-md-4">
                  <label class="form-label">üìä Estado:</label><br />
                  <span
                    id="statusBadge"
                    class="badge bg-secondary status-badge"
                  >
                    <i class="fas fa-pause"></i> Listo para consultar
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="monitor-card card">
            <div class="card-header bg-info text-white">
              <h5><i class="fas fa-clock"></i> Horarios Disponibles</h5>
              <small>Actualizaci√≥n en tiempo real desde MySQL</small>
            </div>
            <div class="card-body">
              <div id="horariosDisplay" class="text-center">
                <p class="text-muted">
                  Haz clic en "Consultar Ahora" para ver los horarios
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="monitor-card card">
            <div class="card-header bg-dark text-white">
              <h5><i class="fas fa-terminal"></i> Log de Actividad</h5>
              <button
                class="btn btn-sm btn-outline-light float-end"
                onclick="clearLog()"
              >
                <i class="fas fa-trash"></i> Limpiar
              </button>
            </div>
            <div class="card-body p-2">
              <div id="logArea" class="log-area"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="monitor-card card">
            <div class="card-header bg-warning text-dark">
              <h5>
                <i class="fas fa-instructions"></i> Instrucciones para la Prueba
              </h5>
            </div>
            <div class="card-body">
              <ol>
                <li>
                  <strong>Paso 1:</strong> Haz clic en "Consultar Ahora" para
                  ver los horarios actuales
                </li>
                <li>
                  <strong>Paso 2:</strong> Ve a la aplicaci√≥n principal y haz
                  una reserva para uno de los horarios
                </li>
                <li>
                  <strong>Paso 3:</strong> Regresa aqu√≠ y vuelve a consultar -
                  deber√≠as ver el horario como OCUPADO
                </li>
                <li>
                  <strong>Paso 4:</strong> Opcional: Activa "Auto-refresh" para
                  monitoreo continuo
                </li>
              </ol>
              <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle"></i>
                <strong>¬øQu√© estamos probando?</strong> Que despu√©s de hacer una
                reserva, los horarios se actualicen autom√°ticamente sin recargar
                la p√°gina.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="src/frontend/api-helper.js"></script>
    <script>
      let autoRefreshInterval = null;
      let consultaCount = 0;

      function log(message, type = "info") {
        const logArea = document.getElementById("logArea");
        const timestamp = new Date().toLocaleTimeString();
        const icon = type === "error" ? "‚ùå" : type === "success" ? "‚úÖ" : "‚ÑπÔ∏è";
        const color =
          type === "error"
            ? "#ff6b6b"
            : type === "success"
            ? "#51cf66"
            : "#74c0fc";

        logArea.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">
                [${timestamp}] ${icon} ${message}
            </div>`;
        logArea.scrollTop = logArea.scrollHeight;
      }

      function clearLog() {
        document.getElementById("logArea").innerHTML = "";
        log("Log limpiado", "info");
      }

      function updateStatus(message, type = "secondary") {
        const badge = document.getElementById("statusBadge");
        const icon =
          type === "success"
            ? "check-circle"
            : type === "danger"
            ? "exclamation-triangle"
            : type === "warning"
            ? "clock"
            : "pause";
        badge.className = `badge bg-${type} status-badge`;
        badge.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
      }

      async function consultarHorarios() {
        const fecha = document.getElementById("fechaMonitor").value;
        const btnConsultar = document.getElementById("btnConsultar");

        consultaCount++;
        log(
          `üöÄ Consulta #${consultaCount} - Solicitando horarios para ${fecha}`,
          "info"
        );
        updateStatus("Consultando...", "warning");

        // Animaci√≥n del bot√≥n
        btnConsultar.innerHTML =
          '<i class="fas fa-sync-alt refresh-btn"></i> Consultando...';
        btnConsultar.disabled = true;

        try {
          if (typeof apiRequest === "undefined") {
            throw new Error("apiRequest no disponible");
          }

          const timestamp = new Date().getTime();
          const endpoint = `/bookings/available-slots?date=${fecha}&_t=${timestamp}&monitor=true`;
          log(`üì° Endpoint: ${endpoint}`, "info");

          const startTime = performance.now();
          const data = await apiRequest(endpoint);
          const endTime = performance.now();
          const responseTime = Math.round(endTime - startTime);

          log(`üìä Respuesta recibida en ${responseTime}ms`, "success");
          log(`üèõÔ∏è Origen: ${data.dataSource || "unknown"}`, "info");

          if (data && data.data && Array.isArray(data.data)) {
            mostrarHorarios(data.data, data.summary || {});
            updateStatus(`${data.data.length} horarios cargados`, "success");
            log(
              `‚úÖ Procesados ${data.data.length} horarios correctamente`,
              "success"
            );
          } else {
            throw new Error("Formato de respuesta inv√°lido");
          }
        } catch (error) {
          log(`‚ùå Error: ${error.message}`, "error");
          updateStatus("Error en consulta", "danger");
          document.getElementById("horariosDisplay").innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error: ${error.message}
                    </div>`;
        } finally {
          btnConsultar.innerHTML =
            '<i class="fas fa-sync-alt"></i> Consultar Ahora';
          btnConsultar.disabled = false;
        }
      }

      function mostrarHorarios(horarios, summary) {
        const display = document.getElementById("horariosDisplay");
        let html = "";

        // Resumen
        if (summary && summary.total) {
          html += `
                    <div class="row mb-3">
                        <div class="col text-center">
                            <span class="badge bg-primary me-2">${
                              summary.total || 0
                            } Total</span>
                            <span class="badge bg-success me-2">${
                              summary.available || 0
                            } Disponibles</span>
                            <span class="badge bg-danger">${
                              summary.booked || 0
                            } Ocupados</span>
                        </div>
                    </div>
                `;
        }

        // Horarios
        html += '<div class="row">';
        horarios.forEach((slot, index) => {
          const isOcupado = slot.isBooked === true;
          const claseCSS = isOcupado ? "horario-ocupado" : "horario-disponible";
          const icono = isOcupado
            ? "fas fa-times-circle"
            : "fas fa-check-circle";
          const estado = isOcupado ? "OCUPADO" : "DISPONIBLE";

          log(
            `${isOcupado ? "üîí" : "‚úÖ"} ${slot.time} - ${estado}`,
            isOcupado ? "error" : "success"
          );

          html += `
                    <div class="col-md-6 mb-2">
                        <div class="card ${claseCSS}">
                            <div class="card-body text-center py-2">
                                <h6 class="mb-1">
                                    <i class="${icono}"></i> ${slot.time}
                                </h6>
                                <small>${estado}</small>
                            </div>
                        </div>
                    </div>
                `;
        });
        html += "</div>";

        display.innerHTML = html;
      }

      function toggleAutoRefresh() {
        const btnAuto = document.getElementById("btnAuto");

        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          btnAuto.innerHTML = '<i class="fas fa-play"></i> Auto-refresh';
          btnAuto.className = "btn btn-info ms-2";
          log("üõë Auto-refresh desactivado", "info");
          updateStatus("Auto-refresh OFF", "secondary");
        } else {
          autoRefreshInterval = setInterval(consultarHorarios, 5000); // Cada 5 segundos
          btnAuto.innerHTML = '<i class="fas fa-pause"></i> Detener';
          btnAuto.className = "btn btn-warning ms-2";
          log("üîÑ Auto-refresh activado (cada 5 segundos)", "success");
          updateStatus("Auto-refresh ON", "success");
          consultarHorarios(); // Primera consulta inmediata
        }
      }

      // Inicializaci√≥n
      window.onload = () => {
        log("üéØ Monitor de Reservas iniciado", "success");
        log("üîó Esperando a que apiRequest est√© disponible...", "info");

        // Verificar apiRequest con reintentos
        let attempts = 0;
        const checkApiRequest = () => {
          attempts++;
          if (typeof window.apiRequest === "function") {
            log("‚úÖ apiRequest disponible - Sistema listo", "success");
            updateStatus("Sistema listo", "success");
          } else if (attempts < 10) {
            setTimeout(checkApiRequest, 500);
            log(`‚è≥ Reintento ${attempts}/10...`, "info");
          } else {
            log("‚ùå apiRequest no disponible despu√©s de 10 intentos", "error");
            updateStatus("Error: API no disponible", "danger");
          }
        };

        setTimeout(checkApiRequest, 1000);
      };
    </script>
  </body>
</html>
